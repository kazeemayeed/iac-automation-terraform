#!/bin/bash
set -e

echo "Setting up Terraform DevOps Project..."

# Create project structure
mkdir -p terraform-project/{modules/{network,compute},environments/{dev,prod}}

# Create unique S3 bucket name
BUCKET_NAME="terraform-state-$(date +%s)-$(whoami)"
echo "Creating S3 bucket: $BUCKET_NAME"

# Create S3 bucket for state
aws s3 mb s3://$BUCKET_NAME

# Create DynamoDB table for state locking
aws dynamodb create-table \
    --table-name terraform-lock-table \
    --attribute-definitions AttributeName=LockID,AttributeType=S \
    --key-schema AttributeName=LockID,KeyType=HASH \
    --provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
    --region us-east-1

echo "Setup complete!"
echo "Update backend.tf with your S3 bucket name: $BUCKET_NAME"

# File: deploy.sh
#!/bin/bash
set -e

ENVIRONMENT=${1:-dev}
ACTION=${2:-plan}

echo "Deploying to $ENVIRONMENT environment..."

# Navigate to project directory
cd terraform-project

# Initialize Terraform
terraform init

# Execute action
case $ACTION in
    plan)
        terraform plan -var-file="environments/${ENVIRONMENT}/terraform.tfvars"
        ;;
    apply)
        terraform plan -var-file="environments/${ENVIRONMENT}/terraform.tfvars" -out=tfplan
        echo "Review plan above. Press Enter to continue..."
        read
        terraform apply tfplan
        echo "Website URL: http://$(terraform output -raw load_balancer_dns)"
        ;;
    destroy)
        terraform destroy -var-file="environments/${ENVIRONMENT}/terraform.tfvars" -auto-approve
        ;;
    *)
        echo "Usage: $0 [dev|prod] [plan|apply|destroy]"
        exit 1
        ;;
esac
